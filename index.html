<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²“è²“å»èƒŒå·¥å…· v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #fff; padding: 15px; min-height: 100vh; }
        h1 { text-align: center; margin-bottom: 15px; font-size: 1.3rem; }
        .upload-area { border: 2px dashed #4a4a6a; border-radius: 12px; padding: 30px 20px; text-align: center; margin-bottom: 15px; cursor: pointer; }
        .upload-area input { display: none; }
        .images-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px; }
        @media (min-width: 768px) { .images-grid { grid-template-columns: repeat(3, 1fr); } }
        .image-card { background: #252545; border-radius: 12px; padding: 12px; }
        .image-card h3 { font-size: 0.8rem; margin-bottom: 8px; word-break: break-all; color: #aaa; }
        .preview-box { position: relative; width: 100%; padding-bottom: 100%; margin-bottom: 10px; border-radius: 8px; overflow: hidden; background: repeating-conic-gradient(#808080 0% 25%, transparent 0% 50%) 50% / 20px 20px; }
        .preview-box canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        .slider-box { margin-bottom: 5px; }
        .slider-box label { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 5px; }
        .threshold-val { color: #6a9a6a; font-weight: bold; }
        input[type="range"] { width: 100%; height: 6px; -webkit-appearance: none; background: #4a4a6a; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #6a9a6a; border-radius: 50%; cursor: pointer; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-primary { background: #6a9a6a; color: #fff; }
        .btn-secondary { background: #4a4a6a; color: #fff; }
        .btn:disabled { opacity: 0.5; }
        .processing { display: none; text-align: center; padding: 20px; }
        .processing.active { display: block; }
        .spinner { width: 40px; height: 40px; border: 3px solid #4a4a6a; border-top-color: #6a9a6a; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .info { text-align: center; color: #8a8aaa; font-size: 0.8rem; margin-top: 15px; }
        .empty { text-align: center; color: #8a8aaa; padding: 40px; }
    </style>
</head>
<body>
    <h1>ğŸ± è²“è²“å»èƒŒå·¥å…· <small style="font-size:0.5em;color:#888">v2.0</small></h1>
    
    <div class="upload-area" id="uploadArea">
        <input type="file" id="fileInput" accept="image/*" multiple>
        <p>ğŸ“· é»æ“Šä¸Šå‚³åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰</p>
        <p style="font-size: 0.75rem; color: #8a8aaa; margin-top: 5px;">æ¯å¼µåœ–ç‰‡å¯ç¨ç«‹èª¿æ•´é–¾å€¼</p>
    </div>

    <div id="imagesGrid" class="images-grid"></div>

    <div class="processing" id="processing">
        <div class="spinner"></div>
        <p>æ‰“åŒ…ä¸­...</p>
    </div>

    <button class="btn btn-primary" id="downloadBtn" disabled>ğŸ“¦ ä¸‹è¼‰å…¨éƒ¨ ZIP</button>
    <button class="btn btn-secondary" id="resetBtn">ğŸ”„ æ¸…é™¤å…¨éƒ¨</button>

    <div class="info">
        <p>æ‰€æœ‰è™•ç†éƒ½åœ¨æœ¬åœ°å®Œæˆ</p>
        <p>v2.0 - æ¯å¼µåœ–ç‰‡ç¨ç«‹é–¾å€¼æ§åˆ¶</p>
    </div>

    <script>
        let images = [];
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagesGrid = document.getElementById('imagesGrid');
        const downloadBtn = document.getElementById('downloadBtn');
        const processing = document.getElementById('processing');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const imgData = {
                                id: Date.now() + Math.random(),
                                name: file.name.replace(/\.[^/.]+$/, ''),
                                img: img,
                                threshold: 252
                            };
                            images.push(imgData);
                            renderCard(imgData);
                            updateBtn();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function renderCard(data) {
            if (images.length === 1) imagesGrid.innerHTML = '';
            
            const card = document.createElement('div');
            card.className = 'image-card';
            card.innerHTML = `
                <h3>${data.name}</h3>
                <div class="preview-box"><canvas id="c${data.id}"></canvas></div>
                <div class="slider-box">
                    <label><span>é–¾å€¼</span><span class="threshold-val" id="v${data.id}">252</span></label>
                    <input type="range" id="s${data.id}" min="240" max="254" value="252">
                </div>
            `;
            imagesGrid.appendChild(card);

            const slider = document.getElementById(`s${data.id}`);
            const value = document.getElementById(`v${data.id}`);
            
            slider.addEventListener('input', (e) => {
                const t = parseInt(e.target.value);
                value.textContent = t;
                data.threshold = t;
                updateCanvas(data);
            });

            updateCanvas(data);
        }

        function updateCanvas(data) {
            const canvas = document.getElementById(`c${data.id}`);
            const ctx = canvas.getContext('2d');
            const size = 250;
            canvas.width = size;
            canvas.height = size;
            
            const scale = Math.min(size / data.img.width, size / data.img.height);
            const w = data.img.width * scale;
            const h = data.img.height * scale;
            const x = (size - w) / 2;
            const y = (size - h) / 2;

            const processed = removeBg(data.img, data.threshold);
            ctx.drawImage(processed, x, y, w, h);
        }

        function removeBg(img, threshold) {
            const c = document.createElement('canvas');
            c.width = img.width;
            c.height = img.height;
            const x = c.getContext('2d');
            x.drawImage(img, 0, 0);
            const d = x.getImageData(0, 0, c.width, c.height);
            for (let i = 0; i < d.data.length; i += 4) {
                if (d.data[i] > threshold && d.data[i+1] > threshold && d.data[i+2] > threshold) {
                    d.data[i+3] = 0;
                }
            }
            x.putImageData(d, 0, 0);
            return c;
        }

        function updateBtn() { downloadBtn.disabled = images.length === 0; }

        downloadBtn.addEventListener('click', async () => {
            processing.classList.add('active');
            const zip = new JSZip();
            
            for (const img of images) {
                const processed = removeBg(img.img, img.threshold);
                const blob = await new Promise(r => processed.toBlob(r, 'image/png'));
                zip.file(`${img.name}_t${img.threshold}.png`, blob);
            }
            
            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            const ts = [...new Set(images.map(i => i.threshold))].sort().join('_');
            a.download = `cats_t${ts}.zip`;
            a.click();
            URL.revokeObjectURL(url);
            processing.classList.remove('active');
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            images = [];
            fileInput.value = '';
            imagesGrid.innerHTML = '';
            downloadBtn.disabled = true;
        });
    </script>
</body>
</html>
